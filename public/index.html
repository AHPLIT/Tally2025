<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AHPL Tally</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>

  <form id="tallyForm">
    <img src="./AHPL-logo.svg" alt="AHPL-logo">
    <h2>Record a Patron Interaction</h2>

    <h3><label>Department:</label></h3>
    <select id="department" required>
      <option value="">Select</option>
      <option value="Adult Services">Adult Services</option>
      <option value="Youth Services">Youth Services</option>
      <option value="Circulation">Circulation</option>
      <option value="IT Department">IT Department</option>
    </select>

    <h3><label>Interaction Type:</label></h3>
    <select id="qType" required>
      <option value="">Select a department first</option>
    </select>

    <h3><label> Made Referral? <input type="checkbox" id="referral"> </label></h3>

    <div class="form-row">
      <div class="form-column">
        <h3><label for="notes">Notes (optional):</label></h3>
        <textarea id="notes" rows="4"></textarea>
      </div>

      <div class="form-column">
        <h3><label for="feedback">Patron Feedback (optional):</label></h3>
        <textarea id="feedback" rows="4"></textarea>
      </div>
    </div>

    <button type="submit" class="tally-button">Tally!</button>
    <button type="button" class="reports-button" onclick="location.href='reports.html'">Reports</button>

    <!--Back and forward buttons for user nav-->
  <div class="nav-buttons" style="margin:10px; display:flex; gap:10px;">
    <button class="back-btn" onclick="window.history.back()">Back</button>

      <!--forward-->
      <button class="forward-btn" onclick="window.location.href='./reports.html'">Forward</button>    
  </div>

  </form>

  <script>
  const departmentSelect = document.getElementById("department");
  const qTypeSelect = document.getElementById("qType");
  const form = document.getElementById("tallyForm");

  // ðŸ”¹ Load saved department on page load
  window.addEventListener("DOMContentLoaded", () => {
    const savedDept = localStorage.getItem("selectedDepartment");
    if (savedDept) {
      departmentSelect.value = savedDept;
      // Trigger change event so correct qType options load
      departmentSelect.dispatchEvent(new Event("change"));
    }
  });

  // ðŸ”¹ When department changes
  departmentSelect.addEventListener("change", () => {
    const department = departmentSelect.value;

    // Save or clear from localStorage
    if (department) {
      localStorage.setItem("selectedDepartment", department);
    } else {
      localStorage.removeItem("selectedDepartment");
    }

    // Clear existing qType options
    qTypeSelect.innerHTML = '<option value="">Select</option>';

    if (!department) return; // if no department chosen, stop here

    // Fetch department-specific interaction types
    fetch(`/api/types/${encodeURIComponent(department)}`)
      .then(res => res.json())
      .then(types => {
        if (types.length === 0) {
          const opt = document.createElement("option");
          opt.value = "Other";
          opt.textContent = "Other";
          qTypeSelect.appendChild(opt);
        } else {
          types.forEach(type => {
            const opt = document.createElement("option");
            opt.value = type;
            opt.textContent = type;
            qTypeSelect.appendChild(opt);
          });
        }
      })
      .catch(err => {
        console.error("Failed to load interaction types:", err);
        const opt = document.createElement("option");
        opt.value = "Other";
        opt.textContent = "Other";
        qTypeSelect.appendChild(opt);
      });
  });

  // ðŸ”¹ Form submission
  form.addEventListener("submit", e => {
    e.preventDefault();

    const data = {
      department: departmentSelect.value,
      qType: qTypeSelect.value,
      referral: document.getElementById("referral").checked,
      notes: document.getElementById("notes").value,
      feedback: document.getElementById("feedback").value,
      timestamp: new Date().toISOString()
    };

    fetch("/api/tally", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
      .then(res => res.json())
      .then(res => {
        if (res.success) {
          alert("Tally recorded!");
          form.reset();
          qTypeSelect.innerHTML = '<option value="">Select</option>'; // reset menu

          // Restore saved department so they donâ€™t have to reselect
          const savedDept = localStorage.getItem("selectedDepartment");
          if (savedDept) {
            departmentSelect.value = savedDept;
            departmentSelect.dispatchEvent(new Event("change"));
          }
        } else {
          alert("Something went wrong while recording.");
        }
      })
      .catch(err => {
        console.error(err);
        alert("Submission failed.");
      });
  });
</script>
</body>
</html>
