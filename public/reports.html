<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tally Reports</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <form id="reportForm">
    <img src="./AHPL-logo.svg" alt="AHPL-logo">
    <h1>Tally Report Generator</h1>

    <label for="start">Start Date:</label>
    <input type="date" id="start" required>

    <label for="end">End Date:</label>
    <input type="date" id="end" required>

    <label for="departmentFilter">Department:</label>
    <select id="departmentFilter">
      <option value="all">All Departments</option>
      <option value="Adult Services">Adult Services</option>
      <option value="Youth Services">Youth Services</option>
      <option value="Circulation">Circulation</option>
      <option value="IT Department">IT Department</option>
    </select>

    <button type="submit" class="generate-btn">Generate Report</button>
    <button type="button" id="exportBtn" class="export-btn">Export to CSV</button>

    <h2>Report Summary</h2>
    <ul id="summaryList"></ul>

    <h2>Results</h2>
    <ul id="reportResults"></ul>

    <h2>Feedback</h2>
    <ul id="feedbackResults"></ul>

    <div class="nav-buttons" style="margin:10px; display:flex; gap:10px;">
      <button class="back-btn" type="button" onclick="window.history.back()">Back</button>
      <button class="forward-btn" type="button" onclick="window.location.href='./index.html'">Forward</button>    
    </div>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("reportForm");

      // Generate Report
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const start = document.getElementById("start").value;
        const end = document.getElementById("end").value;
        const department = document.getElementById("departmentFilter").value || "all";

        let query = `/api/tally?start=${start}&end=${end}`;
        if (department.toLowerCase() !== "all") query += `&department=${encodeURIComponent(department)}`;

        const res = await fetch(query);
        const data = await res.json();

        const reportResults = document.getElementById("reportResults");
        const summaryList = document.getElementById("summaryList");
        reportResults.innerHTML = "";
        summaryList.innerHTML = "";
        const summaryCounts = {};

        data.forEach(entry => {
          const li = document.createElement("li");
          li.textContent = `[${entry.timestamp}] ${entry.department} - ${entry.qType} - Referral: ${entry.referral ? "Yes":"No"} - Notes: ${entry.notes}`;
          reportResults.appendChild(li);
          summaryCounts[entry.department] = (summaryCounts[entry.department] || 0) + 1;
        });

        for (const dept in summaryCounts) {
          const li = document.createElement("li");
          li.textContent = `${dept}: ${summaryCounts[dept]} interactions`;
          summaryList.appendChild(li);
        }

        // Fetch feedback
        const fbRes = await fetch("/api/feedback");
        const feedbackData = await fbRes.json();
        const feedbackResults = document.getElementById("feedbackResults");
        feedbackResults.innerHTML = "";
        feedbackData.forEach(entry => {
          const li = document.createElement("li");
          li.textContent = `[${entry.timestamp}] ${entry.feedback}`;
          feedbackResults.appendChild(li);
        });
      });

      // Export CSV
      document.getElementById("exportBtn").addEventListener("click", () => {
        const start = document.getElementById("start").value;
        const end = document.getElementById("end").value;
        const department = document.getElementById("departmentFilter").value || "all";
        if (!start || !end) return alert("Please select start and end dates.");

        let exportUrl = `/api/tally/export?start=${start}&end=${end}`;
        if (department.toLowerCase() !== "all") exportUrl += `&department=${encodeURIComponent(department)}`;

        window.location.href = exportUrl;
      });
    });
  </script>
</body>
</html>
